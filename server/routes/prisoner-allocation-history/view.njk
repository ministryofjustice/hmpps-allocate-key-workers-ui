{% extends "partials/layout.njk" %}
{% from "govuk/components/table/macro.njk" import govukTable %}

{% set fullWidth = true %}
{% set pageTitle = "Prisoner Allocation History" %}

{% block innerContent %}

  <div class="govuk-grid-row govuk-!-margin-bottom-2 search-form">
    <div class="govuk-grid-column-full">
      <div class="mini-profile" data-qa="mini-profile">
        <div class="mini-profile-inner">
          <div class="mini-profile-left">
            <img class="mini-profile-person-img" src="/prisoner-image/{{ prisoner.prisonerNumber }}"
                 alt="Image of {{ prisoner | lastNameCommaFirstName }}"
                 loading="lazy" />
          </div>
          <div class="mini-profile-right">
            <p class="govuk-!-margin-bottom-0">
              <a class="govuk-link--no-visited-state" target="_blank"
                 href="{{ prisonerProfileUrl }}/prisoner/{{ prisoner.prisonerNumber }}">{{ prisoner | lastNameCommaFirstName }}</a>
            </p>
            <p>{{ prisoner.prisonerNumber }}</p>
          </div>
          <div class="mini-profile-right">
            <p class="govuk-!-font-weight-bold govuk-!-margin-bottom-0">Location</p>
            <p class="cell-location">{{ prisoner.cellLocation }}</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <h1 class="govuk-heading-l govuk-!-margin-bottom-0">Prisoner key worker allocation history</h1>
  <hr />

  <p class="govuk-heading-m govuk-!-margin-top-4 govuk-!-margin-bottom-4">Current and previous allocations: {{ allocationHistory.length }}</p>

  <div class="govuk-!-width-one-half">
    {% for allocation in allocationHistory %}

      {% if allocation.active %}
        {% set tableCaption = "Current key worker: " + (allocation.keyworker | firstNameSpaceLastName) %}
      {% else %}
        {% set tableCaption = "Previous key worker: " + (allocation.keyworker | firstNameSpaceLastName) %}
      {% endif %}

      {% if allocation.deallocated %}
        {% set deallocatedOn = allocation.deallocated.at | formatDateTime %}
        {% set deallocatedBy = allocation.deallocated.by %}
        {% set deallocationReason = allocation.deallocated.reason.description %}
      {% else %}
        {% set deallocatedOn = "-" %}
        {% set deallocatedBy = "-" %}
        {% set deallocationReason = "-" %}
      {% endif %}

      <div class="dropshadow govuk-!-margin-bottom-6">
        {{ govukTable({
          caption: tableCaption,
          captionClasses: "govuk-table__caption--m search-form",
          firstCellIsHeader: true,
          classes: "govuk-!-margin-bottom-0",
          rows: [
            [
              {
                text: "Establishment",
                classes: "govuk-!-padding-left-2 govuk-!-width-one-half"
              },
              {
                text: allocation.prison.description
              }
            ],
            [
              {
                text: "Allocated on",
                classes: "govuk-!-padding-left-2 govuk-!-width-one-half"
              },
              {
                text: allocation.allocated.at | formatDateTime
              }
            ],
            [
              {
                text: "Allocation type",
                classes: "govuk-!-padding-left-2 govuk-!-width-one-half"
              },
              {
                text: allocation.allocated.reason.description
              }
            ],
            [
              {
                text: "Allocated by",
                classes: "govuk-!-padding-left-2 govuk-!-width-one-half"
              },
              {
                text: allocation.allocated.by
              }
            ],
            [
              {
                text: "Deallocated on",
                classes: "govuk-!-padding-left-2 govuk-!-width-one-half"
              },
              {
                text: deallocatedOn
              }
            ],
            [
              {
                text: "Deallocated by",
                classes: "govuk-!-padding-left-2 govuk-!-width-one-half"
              },
              {
                text: deallocatedBy
              }
            ],
            [
              {
                text: "Deallocation reason",
                classes: "govuk-!-padding-left-2 govuk-!-width-one-half"
              },
              {
                text: deallocationReason
              }
            ]
          ]
        }) }}
      </div>
    {% endfor %}
  </div>
{% endblock %}
