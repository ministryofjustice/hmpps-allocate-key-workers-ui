{% from "partials/statusTag/macro.njk" import statusTag %}
{% from "../../staff-profile-key-worker/components/statCard.njk" import statCard %}
{% from "moj/components/filter/macro.njk" import mojFilter %}
{% from "moj/components/date-picker/macro.njk" import mojDatePicker %}
{% from "partials/hiddenInputs/macro.njk" import hiddenInputs %}

<div class="govuk-grid-row govuk-!-margin-0">
  <h1 class="govuk-heading-l govuk-!-display-inline-block govuk-!-margin-0">{{ staffMember | firstNameSpaceLastName }}</h1>
  <p class="govuk-!-margin-left-2 govuk-!-display-inline-block govuk-!-margin-0 ">
    {{ statusTag({ text: status.description, fullText: true }) }}
  </p>
  {% if user | hasPermission('allocate') %}
    <a class="govuk-!-margin-left-2 govuk-link govuk-link--no-visited-state govuk-!-display-inline-block " href="/{{ policyPath }}/start-update-staff/{{ staffId }}?proceedTo=update-capacity-status-and-working-pattern">Update capacity, status or working pattern</a>
  {% endif %}
</div>
<hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible"/>

<div class="govuk-grid-row">
  <div class="govuk-grid-column-one-quarter left-aligned">
    <h2 class="govuk-heading-s govuk-!-margin-bottom-2">Establishment</h2>
    <p class="govuk-!-margin-bottom-2">{{ user.activeCaseLoad.description }}</p>
  </div>

  <div class="govuk-grid-column-one-quarter left-aligned">
    <h2 class="govuk-heading-s govuk-!-margin-bottom-2">Working pattern</h2>
    <p class="govuk-!-margin-bottom-2">{{ staffRole.scheduleType.description }}</p>
  </div>

  <div class="govuk-grid-column-one-quarter left-aligned">
    <h2 class="govuk-heading-s govuk-!-margin-bottom-2">Prisoners allocated</h2>
    <p class="govuk-!-margin-bottom-2">{{ allocated }}</p>
  </div>

  <div class="govuk-grid-column-one-quarter left-aligned">
    <h2 class="govuk-heading-s govuk-!-margin-bottom-2">Maximum capacity</h2>
    <p class="govuk-!-margin-bottom-2">{{ capacity }}</p>
  </div>
</div>

<hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible"/>

{%- set filterOptionsHtml %}
  <h2 class="govuk-heading-m">Select a date range to view</h2>
  <div class="date-search-form govuk-!-margin-bottom-5">
    {{ mojDatePicker({
      id: "dateFrom",
      name: "dateFrom",
      label: {
        text: "From"
      },
      errorMessage: validationErrors | findError('dateFrom'),
      value: dateFrom,
      maxDate: todayStringGBFormat()
    }) }}

    {{ mojDatePicker({
      id: "dateTo",
      name: "dateTo",
      label: {
        text: "To"
      },
      errorMessage: validationErrors | findError('dateTo'),
      value: dateTo,
      maxDate: todayStringGBFormat()
    }) }}
  </div>

  <h2 class="govuk-heading-m">Select a custom date range to compare against (optional)</h2>
  <div class="date-search-form">
    {{ mojDatePicker({
      id: "compareDateFrom",
      name: "compareDateFrom",
      label: {
        text: "From"
      },
      errorMessage: validationErrors | findError('compareDateFrom'),
      value: compareDateFrom,
      maxDate: todayStringGBFormat()
    }) }}

    {{ mojDatePicker({
      id: "compareDateTo",
      name: "compareDateTo",
      label: {
        text: "To"
      },
      errorMessage: validationErrors | findError('compareDateTo'),
      value: compareDateTo,
      maxDate: todayStringGBFormat()
    }) }}
  </div>
{% endset -%}

<div class="govuk-grid-column-full-width govuk-grid-row">
  <div class="moj-action-bar moj-action-bar-indent">
    <div class="moj-action-bar__filter"></div>
  </div>
  <form id="filter-form" method='GET' class="govuk-grid-column-two-thirds govuk-!-margin-bottom-6">
    {{ hiddenInputs(query | getQueryEntries(['sort', 'js', 'history'])) }}
    {{ mojFilter({
      heading: { text: "Filter" },
      submit:{
        text: "Apply filter",
        attributes: {
          form: "filter-form"
        }
      },
      selectedFilters: {
        heading: {
          text: "Selected filters"
        },
        clearLink: {
          text: "Clear filters",
          href: clearFilterUrl
        },
        categories: [
          {
            heading: {
            text: "Date range to view"
          },
            items: [{
            href: clearDateRangeUrl,
            text: dateFrom + " to " + dateTo
          }]
          } if validated.dateFrom and validated.dateTo,
          {
            heading: {
            text: "Date range to compare against"
          },
            items: [{
            href: clearCompareDateRangeUrl,
            text: compareDateFrom + " to " + compareDateTo
          }]
          } if validated.compareDateFrom and validated.compareDateTo
        ] | removeNullish
      },
      optionsHtml: filterOptionsHtml
    }) }}
  </form>
</div>

<h2 class="govuk-body-l">
  <strong>Statistics for period:</strong>
  Displaying statistics from {{ stats.current.from | dateString }} to {{ stats.current.to | dateString }}. Comparing against statistics from {{ stats.previous.from | dateString }} to {{ stats.previous.to | dateString }}.
</h2>
<div class="govuk-grid-row">
  {{ statCard('Recorded case note entries', stats.current.recordedEvents | mapProperty('count') | sum, stats.previous.recordedEvents | mapProperty('count') | sum) }}
</div>

<hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible"/>

<hr class="govuk-section-break govuk-section-break--m"/>
